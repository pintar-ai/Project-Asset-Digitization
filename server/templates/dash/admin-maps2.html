<!DOCTYPE html>
<html lang="en">

<head>
    <title>Admin Map | Perceptron Services</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        * {
            box-sizing: border-box;
        }

        html {
            overflow-y: scroll;
            
        }

        #mapdiv {
            width: 100%;
            background-color: white;
            height: 100%;
            position: absolute;
            z-index: 1;
            /* only for demonstration, should be removed */
        }

        label {
            color:whitesmoke;
            font-weight: bold;
        }

        #topicabv {
            color:whitesmoke;
            font-weight: bold;
            margin-top: 15px;
            margin-right: 40px;
            z-index: 2;
            cursor: pointer;
            font-family: 'Raleway', sans-serif !important;
            color: rgb(109, 109, 109);
        }

        #copy {
            font-weight: bold;
            right: 0;
            position: absolute;
            font-family: 'Raleway', sans-serif !important;
            color: rgb(241, 241, 241);
        }

        #finalMessage{
            color:whitesmoke;
            font-weight: bold;
            margin-top: 15px;
            margin-right: 40px;
            z-index: 2;
            cursor: pointer;
            font-family: 'Raleway', sans-serif !important;
            color: rgb(255, 255, 255);
        }

        #status{
            color:whitesmoke;
            font-weight: bold;
            margin-top: 15px;
            margin-right: 40px;
            z-index: 2;
            cursor: pointer;
            font-family: 'Raleway', sans-serif !important;
            color: rgb(255, 255, 255);
        }


        #topiccredit {
            color:whitesmoke;
            font-weight: bold;
            margin-top: 15px;
            margin-right: 40px;
            z-index: 2;
            cursor: pointer;
            font-family: 'Raleway', sans-serif !important;
            color: rgb(109, 109, 109);
        }

        #myBtn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed/sticky position */
            bottom: 20px; /* Place the button at the bottom of the page */
            right: 30px; /* Place the button 30px from the right */
            z-index: 99; /* Make sure it does not overlap */
            border: azure; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: rgb(0, 128, 255); /* Set a background color */
            color: white; /* Text color */
            cursor: pointer; /* Add a mouse pointer on hover */
            padding: 15px; /* Some padding */
            border-radius: 20px; /* Rounded corners */
            font-size: 25px; /* Increase font size */
            font-weight: 100;
        }

        #myBtn:hover {
            background-color: rgb(51, 153, 255);
            color: rgb(255, 255, 255); /* Add a dark-grey background on hover */
        }
        
    </style>




    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <!-- Fonts and icons -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />

    <!--   Core JS Files   -->
    <script src="{{url_for('static', filename='assets/js/core/jquery.3.2.1.min.js')}}" type="text/javascript"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/black-tie/jquery-ui.css">

    <!-- FONT -->
    <link href='http://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type='text/css'>

</head>

<body>
    <!-- Blue with white text -->
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark ">
        <p id="topicabv">PERCEPTRON SERVICES</p>

        <ul class="navbar-nav">
            
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('show_admin') }}"><i class="fa fa-home"></i > Dashbaoard </i></a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="{{ url_for('adminmap') }}"><i class="fa fa-map-marker"></i > Map </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('logout') }}"><i class="fa fa-times"></i > Logout</a>
                </li>
                </ul>
    </nav>
    <!--start navbar-->

    
    <div class="pos-f-t ">
            
        <div class="collapse" id="navbarToggleExternalContent">
            <div class="bg-dark p-4">
                <!--<h6 class="text-white">Marker option</h6>-->
                <!--<span class="text-muted"></span>--> <br>

                <!-- START -->

                <div class="container-fluid" >
						<!--start row 1-->
						<div class="row">
							<form action="{{ url_for('searchloc') }}" method="post">
                                <h6><span id="topicabv" style="color:whitesmoke">Tower Location</span></h6>
								<div class="col" >
									<div class="form-group">
										<label for="changestate">Choose State</label>
										<select id="first-choice" class="form-control">
                                                <option selected value="base" disabled>Select State</option>
                                                <option value="terengganu">Terengganu</option>
                                                <option value="selangor">Selangor</option>
                                                <option value="sarawak">Sarawak</option>
                                                <option value="sabah">Sabah</option>
                                                <option value="putrajaya">Putrajaya</option>
                                                <option value="perlis">Perlis</option>
                                                <option value="perak">Perak</option>
                                                <option value="penang">Penang</option>
                                                <option value="negeri9">Negeri Sembilan</option>
                                                <option value="melaka">Melaka</option>
                                                <option value="kualalumpur">Kuala Lumpur</option>
                                                <option value="kelantan">Kelantan</option>
                                                <option value="kedah">Kedah</option>
                                                <option value="johor">Johor</option>
                                            </select>
									</div>
                                </div>
                                
                                <div class="col">
                                    <div class="form-group">
                                        <label for="changestate">District</label>
                                        <select style="height:30px;" class="form-control" id="second-choice" name="state">
                                            <option>Choose State</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col">
                                        <div class="form-group">
                                            <button onclick='start(0)'  class="btn btn-primary" type="submit" value="clear">Search</button>
                                        </div>
                                    </div>
                                </form>
                                <form action="{{ url_for('pushadmin') }}" method="get">
                                    <h6><span id="topicabv" style="color:whitesmoke">Flight Information (Date)</span></h6>
                                    <div class="col">
                                        <label for="changestate">Filter Date</label>
                                        <input style="z-index:1;" class="form-control" name="date" id="datepicker2" placeholder="Filter by Date" >
                                        
                                    </div> <br>
                                    <div class="col">
                                            <div class="form-group">
                                                <button onclick='start(0)'  class="btn btn-primary" type="submit" value="clear">Search</button>
                                            </div>
                                    </div>

                                </form>
                                <form onReset="filterMarker(this.value);">
                                        <h6><span id="topicabv" style="color:whitesmoke">Flight Information (User)</span></h6>
                                        <div class="col">
                                                <div class="form-group">
                                                    <label for="changestate">Filter Username</label>
                                                    <select class="form-control" name="user" id="filterUsername">
                                                        <option value='all'>All Users</option>
            
                                                        {% for users in user %}
                                                        <option value="{{users}}">{{users}}</option>
                                                        {% endfor %}
            
                                                        <option disabled selected="selected"> Username</option>
                                                    </select>
                                                </div>
                                            </div>
    
                                        <div class="col">
                                            <div class="form-group">
                                                <label  for="changestate">Select All</label>
                                                <input  type="checkbox" onchange="filterMarker(this.value);" value="all">
                                            </div>
                                        </div>
                                        <!--
                                        <div class="col">
                                            <div class="form-group">
                                                <button  class="btn btn-primary" type="reset" value="clear">Reset</button>
                                            </div>
                                        </div>
                                        -->
    
    
                                    </form> 
                                    
                    </div>
                    
                    <!--next row-->
                    
				</div>

                <!-- END-->






            </div>
        </div>

        <!--JANGAN UBAH-->
        <nav class="navbar navbar-dark bg-primary ">
                
            <button class="navbar-toggler" type="button" data-toggle="collapse"
                data-target="#navbarToggleExternalContent" aria-controls="navbarToggleExternalContent"
                aria-expanded="false" aria-label="Toggle navigation">
                
                <span class="navbar-toggler-icon"></span>
            </button>
            <small id="copy"> Copyright &copy; <script>document.write(new Date().getFullYear())</script> Dr Ibrahim.</small>
            
            <div>
            {% with messages = get_flashed_messages() %}
					{% if messages %}
					{% for message in messages %}
                        <div class="alert alert-warning" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                    aria-hidden="true">×</span></button>
                            {{message}}
                        </div>
					{% endfor %}
					{% endif %}
					{% endwith %}
				
                    {% block body %}{% endblock %}
            </div>

        </nav>
    </div>
    
    <!--end navbar-->
    <!--
    <div class="container-fluid">
        <h1>My First Bootstrap Page</h1>
        <p>This part is inside a .container-fluid class.</p>
        <p>The .container-fluid class provides a full width container, spanning the entire width of the viewport.</p>
    </div>
    -->
    <button onclick="topFunction()" id="myBtn" title="Go to top"><i class="fa fa-arrow-circle-o-up"></i></button>


            <div id="mapdiv"></div>
    <script src="http://dev.openlayers.org/OpenLayers.js"></script>


    

    <!-- Filter Date script -->
	<script>
			var captured = {{ marker| tojson }};
			var captelco = {{ telco| tojson }};
	</script>


	<script type="text/javascript">
		jQuery(function () {

			var enableDays = {{ data| safe}};

		function enableAllTheseDays(date) {
			var sdate = $.datepicker.formatDate('yy-mm-dd', date)
			console.log(sdate)
			if ($.inArray(sdate, enableDays) != -1) {
				return [true];
			}
			return [false];
		}

		$('#datepicker2').datepicker({ dateFormat: 'yy-mm-dd', beforeShowDay: enableAllTheseDays });
    })
    </script>

	<script>
		map = new OpenLayers.Map("mapdiv");
		map.addLayer(new OpenLayers.Layer.OSM());

		epsg4326 = new OpenLayers.Projection("EPSG:4326"); //WGS 1984 projection
		projectTo = map.getProjectionObject(); //The map projection (Spherical Mercator)


		if ({{ min1 }} == 0 && {{ min2 }} == 0 && {{ max1 }} == 0 && {{ max2 }} == 0 ) {
			
			console.log("enter normal")
			console.log({{ center }})
			var lonLat = new OpenLayers.LonLat({{ center }} ).transform(epsg4326, projectTo);
			console.log(lonLat)
			var zoom = 4;
			map.setCenter(lonLat, zoom);
            var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
            var vectorLayer2 = new OpenLayers.Layer.Vector("Overlay");
			}
			
		else {
			
			console.log("enter bound")
			bounds = new OpenLayers.Bounds();
			bounds.extend(new OpenLayers.LonLat({{ max1 }}, {{ min1 }}));
			bounds.extend(new OpenLayers.LonLat({{ max2 }}, {{ min2 }}));
			console.log(" Latitude, Latitude, Longitude, Longitude -> "+bounds.toBBOX()); //check the bounds
			var center_lat = bounds.getCenterLonLat()["lat"]
			var center_lon = bounds.getCenterLonLat()["lon"]
			var lon2 = new OpenLayers.LonLat(center_lon,center_lat).transform(epsg4326, projectTo);
			//map.getExtent(bounds);
			map.zoomToExtent(bounds);
			//map.zoomTo(map.getZoomForExtent(bounds));
			map.setCenter(lon2,17);
			//console.log(bounds.getCenterLonLat())
            var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
            var vectorLayer2 = new OpenLayers.Layer.Vector("Overlay");
			
		}

		// Define markers as "features" of the vector layer:


		for (var object in captured) {
			console.log(object)
			var feature = new OpenLayers.Feature.Vector(
				new OpenLayers.Geometry.Point(captured[object].lng, captured[object].lat).transform(epsg4326, projectTo),
				{ description: captured[object].description },
				{ externalGraphic: "{{url_for('static', filename='marker.png')}}", graphicHeight: 30, graphicWidth: 30, graphicXOffset: -12, graphicYOffset: -25 }
			);
			console.log("feature" + captured[object].lng)
			vectorLayer.addFeatures(feature);
		}

		for (var object1 in captelco) {
			console.log("check")
			var featuretelco = new OpenLayers.Feature.Vector(
				new OpenLayers.Geometry.Point(captelco[object1].lng, captelco[object1].lat).transform(epsg4326, projectTo),{ description: captelco[object1].description },
				{ externalGraphic: "{{url_for('static', filename='antenna.png')}}", graphicHeight: 30, graphicWidth: 30, graphicXOffset: -12, graphicYOffset: -25 }
			);
            //console.log("feature captelco" + captelco[object1].description);
			vectorLayer2.addFeatures(featuretelco);

		}

		
		map.addLayer(vectorLayer);
        map.addLayer(vectorLayer2);


		//Add a selector control to the vectorLayer with popup functions
		var controls = {
			selector: new OpenLayers.Control.SelectFeature([ vectorLayer, vectorLayer2], { onSelect: createPopup, onUnselect: destroyPopup })
		};

		function createPopup(feature) {
			feature.popup = new OpenLayers.Popup.FramedCloud("pop",
				feature.geometry.getBounds().getCenterLonLat(),
				null,
				'<div class="markerContent">' + feature.attributes.description + '</div>',
				null,
				true,
				function () { controls['selector'].unselectAll(); }
			);
			//feature.popup.closeOnMove = true;
			map.addPopup(feature.popup);
		}

		function destroyPopup(feature) {
			feature.popup.destroy();
			feature.popup = null;
		}

		map.addControl(controls['selector']);
        controls['selector'].activate();

        var exist = true;


        map.events.register("zoomend", map, function(){
            var curZoom = map.getZoom();

            console.log(curZoom + " and "+ exist);
            if(curZoom < 15){
                console.log("1st before "+exist);
                vectorLayer2.display(false);
                console.log("1st after "+exist);
            }
            else {
                console.log("2nd before "+exist);
                vectorLayer2.display(true);
                exist = false;
                console.log("2nd after "+ exist);
            }
        });
	</script>

    </div>
    
	<script>
        $("#first-choice").change(function() {
            $("#second-choice").load("{{url_for('static', filename='districtdata3/')}}" + $(this).val() + ".txt");
        });
    </script>

    <script>
        
        $("#filterUsername").change(function(){
            var username = $("[id=filterUsername]").val()
                $.ajax({
                    url: '/getFLightUsername', 
                    type: 'POST', 
                    data: username, 

                    success: function(marker){
                        var captured = JSON.parse(marker.marker);

                        if (map) {
                            console.log(captured)
                            map.removeLayer(vectorLayer);
                            //var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
                            vectorLayer.removeAllFeatures();

                            for (var object in captured) {
                                console.log(captured[object].lng)
                                var feature = new OpenLayers.Feature.Vector(
                                    new OpenLayers.Geometry.Point(parseFloat(captured[object].lng), parseFloat(captured[object].lat)).transform(epsg4326, projectTo),
                                    { description: captured[object].description },
                                    { externalGraphic: "{{url_for('static', filename='marker.png')}}", graphicHeight: 30, graphicWidth: 30, graphicXOffset: -12, graphicYOffset: -25 }
                                );
                                console.log(feature)
                                vectorLayer.addFeatures(feature);

                            }
                            map.addLayer(vectorLayer);
                        }
                }});
        });

    
    </script>
          
    <script>
        // When the user scrolls down 20px from the top of the document, show the button
        window.onscroll = function() {scrollFunction()};

        function scrollFunction() {
        if (document.body.scrollTop > 0 || document.documentElement.scrollTop > 0) {
            document.getElementById("myBtn").style.display = "block";
        } else {
            document.getElementById("myBtn").style.display = "none";
        }
        }

        // When the user clicks on the button, scroll to the top of the document
        function topFunction() {
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        }

        $( "#myBTn" ).click(function() {
            alert( "Handler for .click() called." );
            });
    </script>

    <script>
        function isFunction(functionToCheck) {
      return functionToCheck && {}.toString.call(functionToCheck) === '[object Function]';
    }

    function debounce(func, wait) {
        var timeout;
        var waitFunc;

        return function() {
            if (isFunction(wait)) {
                waitFunc = wait;
            }
            else {
                waitFunc = function() { return wait };
            }

            var context = this, args = arguments;
            var later = function() {
                timeout = null;
                func.apply(context, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, waitFunc());
        };
    }

    // reconnectFrequencySeconds doubles every retry
    var reconnectFrequencySeconds = 1;
    var evtSource;

    var reconnectFunc = debounce(function() {
        setupEventSource();
        // Double every attempt to avoid overwhelming server
        reconnectFrequencySeconds *= 2;
        // Max out at ~1 minute as a compromise between user experience and server load
        if (reconnectFrequencySeconds >= 64) {
            reconnectFrequencySeconds = 64;
        }
    }, function() { return reconnectFrequencySeconds * 1000 });
    /*
    var source = new EventSource('/stream');
    source.onmessage = function (event) {
      if(event.data!="no data"){
        alert(event.data);
      }
        
    };
    */
    function setupEventSource() {
      evtSource = new EventSource('/streamadmin'); 
      evtSource.onmessage = function(e) {
        // Handle even here
        if(e.data!="no data"){
        
        console.log(e.data)
        var captured = $.parseJSON(e.data);

        if (map) {
            console.log(captured)
            map.removeLayer(vectorLayer);
            //var vectorLayer = new OpenLayers.Layer.Vector("Overlay");
            vectorLayer.removeAllFeatures();

            for (var object in captured) {
                console.log(captured[object].lng)
                var feature = new OpenLayers.Feature.Vector(
                    new OpenLayers.Geometry.Point(parseFloat(captured[object].lng), parseFloat(captured[object].lat)).transform(epsg4326, projectTo),
                    { description: captured[object].description },
                    { externalGraphic: "{{url_for('static', filename='marker.png')}}", graphicHeight: 30, graphicWidth: 30, graphicXOffset: -12, graphicYOffset: -25 }
                );
                console.log(feature)
                vectorLayer.addFeatures(feature);

            }


            map.addLayer(vectorLayer);
        }

        
      }
      };
      evtSource.onopen = function(e) {
        // Reset reconnect frequency upon successful connection
        reconnectFrequencySeconds = 1;
      };
      evtSource.onerror = function(e) {
        evtSource.close();
        reconnectFunc();
      };
    }
    setupEventSource();
    </script>



</body>

</html>
